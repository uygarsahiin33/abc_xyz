WITH
-- 1) ÜRÜN x GÜN günlük toplam (tüm mağazalar), son 180 gün
daily AS (
  SELECT
    CAST(date_of_transaction AS date) AS tx_date,
    item_number,
    SUM(quantity_sold) AS daily_qty_allstores
  FROM nessie.selfservis_migros.v_daily_store_item_sale
  WHERE CAST(date_of_transaction AS date)
        BETWEEN date_add('day', -180, current_date) AND current_date
  GROUP BY 1, 2
),

-- 2) ÜRÜN bazında: toplam satış ve günlük kareler toplamı (∑x, ∑x²)
agg AS (
  SELECT
    item_number,
    SUM(daily_qty_allstores)                                                AS total_sales_180d,
    SUM( CAST(daily_qty_allstores AS double) * CAST(daily_qty_allstores AS double) ) AS sumsq_180d
  FROM daily
  GROUP BY 1
),

-- 3) N (gün sayısı) ile popülasyon varyansı: var = (∑x² / N) - ( (∑x / N)² )
varcalc AS (
  SELECT
    a.item_number,
    a.total_sales_180d,
    a.sumsq_180d,
    n.N_days,
    (a.sumsq_180d / n.N_days)
      - POWER( (CAST(a.total_sales_180d AS double) / n.N_days), 2 )        AS variance_180d
  FROM agg a
  CROSS JOIN (
    SELECT CAST(date_diff('day', date_add('day', -180, current_date), current_date) + 1 AS double) AS N_days
  ) n
),

-- 4) Basit %20/%40/%40 dilimleri: NTILE(5)
bucketed AS (
  SELECT
    item_number,
    total_sales_180d,
    variance_180d,
    NTILE(5) OVER (ORDER BY total_sales_180d DESC) AS sales_q5,
    NTILE(5) OVER (ORDER BY variance_180d  DESC)   AS var_q5
  FROM varcalc
),

-- 5) Etiketler ve çarpan
labeled AS (
  SELECT
    item_number,
    total_sales_180d,
    variance_180d,
    CASE
      WHEN sales_q5 = 1 THEN 'A'
      WHEN sales_q5 IN (2,3) THEN 'B'
      ELSE 'C'
    END AS a_class,
    CASE
      WHEN var_q5 = 1 THEN 'X'
      WHEN var_q5 IN (2,3) THEN 'Y'
      ELSE 'Z'
    END AS x_class
  FROM bucketed
),

final AS (
  SELECT
    CAST(item_number AS varchar)                    AS "Ürün Kodu",
    total_sales_180d                                AS "Toplam Satış",
    variance_180d                                   AS "Varyans",
    (a_class || x_class)                            AS abc_xyz,
    (a_class || x_class)                            AS "ABC-XYZ Sonucu",
    CASE (a_class || x_class)
      WHEN 'AX' THEN 1.88
      WHEN 'AY' THEN 1.64
      WHEN 'AZ' THEN 1.48
      WHEN 'BX' THEN 1.34
      WHEN 'BY' THEN 1.28
      WHEN 'BZ' THEN 1.23
      WHEN 'CX' THEN 1.13
      WHEN 'CY' THEN 1.04
      WHEN 'CZ' THEN 0.84
      ELSE 1.00
    END                                             AS "Çarpanı"
  FROM labeled
)

SELECT *
FROM final
-- Örnek filtre: WHERE abc_xyz = 'AX'
ORDER BY
  CASE abc_xyz
    WHEN 'AX' THEN 1 WHEN 'AY' THEN 2 WHEN 'AZ' THEN 3
    WHEN 'BX' THEN 4 WHEN 'BY' THEN 5 WHEN 'BZ' THEN 6
    WHEN 'CX' THEN 7 WHEN 'CY' THEN 8 WHEN 'CZ' THEN 9
    ELSE 10 END,
  "Ürün Kodu";
