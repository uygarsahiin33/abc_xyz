-- Ürün Kodu | Toplam Satış | Varyans | ABC-XYZ Sonucu | Çarpanı
WITH
raw_daily_item AS (               -- 1) Gün+ürün: tüm mağazalarda günlük toplam (son 180 gün)
  SELECT
    CAST(date_of_transaction AS date) AS tx_date,
    item_number,
    SUM(quantity_sold) AS qty_daily_allstores
  FROM nessie.selfservis_migros.v_daily_store_item_sale
  WHERE CAST(date_of_transaction AS date)
        BETWEEN date_add('day', -180, current_date) AND current_date
  GROUP BY 1, 2
),

items AS (                        -- 2) Pencerede görünen ürün evreni
  SELECT DISTINCT item_number FROM raw_daily_item
),

calendar AS (                     -- 3) 180 günlük takvim (uçlar dahil)
  SELECT d AS tx_date
  FROM (
    SELECT sequence(date_add('day', -180, current_date), current_date, interval '1' day) AS days
  )
  CROSS JOIN UNNEST(days) AS u(d)
),

grid AS (                         -- 4) Ürün x Gün ızgarası
  SELECT c.tx_date, i.item_number
  FROM calendar c
  CROSS JOIN items i
),

daily AS (                        -- 5) Eksik günleri 0 ile doldur
  SELECT
    g.item_number,
    g.tx_date,
    COALESCE(r.qty_daily_allstores, 0) AS daily_qty
  FROM grid g
  LEFT JOIN raw_daily_item r
    ON r.item_number = g.item_number
   AND r.tx_date     = g.tx_date
),

agg AS (                          -- 6) 180 günde toplam satış + günlük varyans (var_pop)
  SELECT
    item_number,
    SUM(daily_qty)     AS total_sales_180d,
    var_pop(daily_qty) AS variance_180d       -- stddev_pop(daily_qty)^2 ile eşdeğer
  FROM daily
  GROUP BY 1
),

ranked AS (                       -- 7) Basit %20/%40/%40: PERCENT_RANK ile
  SELECT
    item_number,
    total_sales_180d,
    variance_180d,
    PERCENT_RANK() OVER (ORDER BY total_sales_180d DESC) AS pr_sales,
    PERCENT_RANK() OVER (ORDER BY variance_180d  DESC)   AS pr_var
  FROM agg
),

labeled AS (                      -- 8) ABC & XYZ etiketleri
  SELECT
    item_number,
    total_sales_180d,
    variance_180d,
    CASE
      WHEN pr_sales <= 0.20 THEN 'A'
      WHEN pr_sales <= 0.60 THEN 'B'
      ELSE 'C'
    END AS a_class,
    CASE
      WHEN pr_var   <= 0.20 THEN 'X'
      WHEN pr_var   <= 0.60 THEN 'Y'
      ELSE 'Z'
    END AS x_class
  FROM ranked
),

final AS (                        -- 9) Nihai çıktı + çarpan
  SELECT
    CAST(item_number AS varchar)           AS "Ürün Kodu",
    total_sales_180d                       AS "Toplam Satış",
    variance_180d                          AS "Varyans",
    (a_class || x_class)                   AS abc_xyz,
    (a_class || x_class)                   AS "ABC-XYZ Sonucu",
    CASE (a_class || x_class)
      WHEN 'AX' THEN 1.88
      WHEN 'AY' THEN 1.64
      WHEN 'AZ' THEN 1.48
      WHEN 'BX' THEN 1.34
      WHEN 'BY' THEN 1.28
      WHEN 'BZ' THEN 1.23
      WHEN 'CX' THEN 1.13
      WHEN 'CY' THEN 1.04
      WHEN 'CZ' THEN 0.84
      ELSE 1.00
    END                                     AS "Çarpanı"
  FROM labeled
)

SELECT *
FROM final
-- Örnek filtre: WHERE abc_xyz = 'AX'
ORDER BY
  CASE abc_xyz
    WHEN 'AX' THEN 1 WHEN 'AY' THEN 2 WHEN 'AZ' THEN 3
    WHEN 'BX' THEN 4 WHEN 'BY' THEN 5 WHEN 'BZ' THEN 6
    WHEN 'CX' THEN 7 WHEN 'CY' THEN 8 WHEN 'CZ' THEN 9
    ELSE 10 END,
  "Ürün Kodu";
