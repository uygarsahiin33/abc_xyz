-- TRINO / PRESTO UYUMLU: Son 6 ay, Mağaza Kodu + Ürün Kodu için toplam satış ve günlük varyans
WITH params AS (
  SELECT
    date_add('month', -6, current_date) AS start_date,
    current_date                        AS end_date
),
raw AS (
  SELECT
    CAST(date_of_transaction AS date) AS tx_date,
    store_number,
    item_number,
    SUM(quantity_sold) AS qty
  FROM selfservis_migros.v_daily_store_item_sale s
  JOIN params p ON CAST(date_of_transaction AS date) BETWEEN p.start_date AND p.end_date
  GROUP BY 1, 2, 3
),
pairs AS (
  SELECT DISTINCT store_number, item_number FROM raw
),
calendar AS (
  SELECT d AS tx_date
  FROM (
    SELECT sequence(p.start_date, p.end_date, interval '1' day) AS days
    FROM params p
  )
  CROSS JOIN UNNEST(days) AS u(d)
),
grid AS (
  SELECT c.tx_date, pr.store_number, pr.item_number
  FROM calendar c
  CROSS JOIN pairs pr
),
daily AS (
  SELECT
    g.store_number,
    g.item_number,
    g.tx_date,
    COALESCE(r.qty, 0) AS daily_qty
  FROM grid g
  LEFT JOIN raw r
    ON r.store_number = g.store_number
   AND r.item_number  = g.item_number
   AND r.tx_date      = g.tx_date
),
agg AS (
  SELECT
    store_number,
    item_number,
    SUM(daily_qty)            AS total_sales_6m,
    COALESCE(var_pop(daily_qty), 0) AS variance_6m
  FROM daily
  GROUP BY 1, 2
),
ranked AS (
  SELECT
    store_number,
    item_number,
    total_sales_6m,
    variance_6m,
    PERCENT_RANK() OVER (ORDER BY total_sales_6m DESC) AS pr_sales,
    PERCENT_RANK() OVER (ORDER BY variance_6m  ASC)    AS pr_var
  FROM agg
),
labeled AS (
  SELECT
    store_number,
    item_number,
    total_sales_6m,
    variance_6m,
    CASE
      WHEN pr_sales <= 0.20 THEN 'A'
      WHEN pr_sales <= 0.60 THEN 'B'
      ELSE 'C'
    END AS a_class,
    CASE
      WHEN pr_var <= 0.20 THEN 'X'
      WHEN pr_var <= 0.60 THEN 'Y'
      ELSE 'Z'
    END AS x_class
  FROM ranked
)
SELECT
  CAST(store_number AS varchar) AS "Mağaza Kodu",
  CAST(item_number  AS varchar) AS "Ürün Kodu",
  total_sales_6m                 AS "Toplam Satış (6 Ay)",
  variance_6m                    AS "Varyans",
  a_class || x_class             AS "ABC-XYZ Sonucu",
  CASE a_class || x_class
    WHEN 'AX' THEN 1.88
    WHEN 'AY' THEN 1.64
    WHEN 'AZ' THEN 1.48
    WHEN 'BX' THEN 1.34
    WHEN 'BY' THEN 1.28
    WHEN 'BZ' THEN 1.23
    WHEN 'CX' THEN 1.13
    WHEN 'CY' THEN 1.04
    WHEN 'CZ' THEN 0.84
    ELSE 1.00
  END                           AS "ABC-XYZ'e göre çarpan"
FROM labeled
ORDER BY
  CASE a_class || x_class
    WHEN 'AX' THEN 1 WHEN 'AY' THEN 2 WHEN 'AZ' THEN 3
    WHEN 'BX' THEN 4 WHEN 'BY' THEN 5 WHEN 'BZ' THEN 6
    WHEN 'CX' THEN 7 WHEN 'CY' THEN 8 WHEN 'CZ' THEN 9
    ELSE 10 END,
  "Mağaza Kodu",
  "Ürün Kodu";
